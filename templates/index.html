<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webcam Stream</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            text-align: center;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-bottom: 20px;
        }

        select,
        button {
            font-size: 16px;
            padding: 10px;
            margin: 10px 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background-color: #007bff;
            cursor: pointer;
            color: white;
        }

        button:hover {
            background-color: #0056b3;
        }

        .button-green {
            background-color: #28a745;
            color: white;
        }

        .button-green:hover {
            background-color: #218838;
        }

        .button-red {
            background-color: #dc3545;
            color: white;
        }

        .button-red:hover {
            background-color: #c82333;
        }

        #video {
            margin-top: 20px;
            border: 5px solid #ddd;
            border-radius: 8px;
            width: 640px;
            height: 480px;
            background-color: black;
            object-fit: cover;
            /* This ensures the video fits within the div without resizing */
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Webcam Stream</h1>
        <select id="videoSource"></select>
        <div>
            <button id="startButton">Start Stream</button>
            <button id="stopButton">Stop Stream</button>
            <button id="toggleDetectionButton" class="button-red">Enable Detection</button>
        </div>
        <img id="video" alt="Webcam Stream">
        <!-- <video id="video" autoplay></video> -->

        <script>
            const videoElement = document.getElementById('video');
            const videoSelect = document.getElementById('videoSource');
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const toggleDetectionButton = document.getElementById('toggleDetectionButton');
            let currentStream;
            let isDetectionEnabled = false;

            // Function to handle devices
            navigator.mediaDevices.enumerateDevices().then(gotDevices).catch(handleError);

            function gotDevices(deviceInfos) {
                const values = videoSelect.value;
                while (videoSelect.firstChild) {
                    videoSelect.removeChild(videoSelect.firstChild);
                }
                for (let i = 0; i !== deviceInfos.length; ++i) {
                    const deviceInfo = deviceInfos[i];
                    const option = document.createElement('option');
                    option.value = deviceInfo.deviceId;
                    if (deviceInfo.kind === 'videoinput') {
                        option.text = deviceInfo.label || `camera ${videoSelect.length + 1}`;
                        videoSelect.appendChild(option);
                    }
                }
                if (Array.prototype.slice.call(videoSelect.childNodes).some(n => n.value === values)) {
                    videoSelect.value = values;
                }
                console.log("Devices populated:", deviceInfos);
            }

            function handleError(error) {
                console.error('Error: ', error);
            }

            async function startStream() {
                console.log("Starting stream...");
                if (typeof currentStream !== 'undefined') {
                    console.log("Stopping existing stream before starting a new one...");
                    stopStream();
                }
                const videoSource = videoSelect.value;
                const constraints = {
                    video: {
                        deviceId: videoSource ? { exact: videoSource } : undefined
                    }
                };
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoElement.srcObject = currentStream;
                    videoSelect.disabled = true;  // Disable the dropdown
                    const detectionParam = isDetectionEnabled ? 'true' : 'false';
                    videoElement.src = `/video_feed?detection=${detectionParam}`;
                    console.log(`Stream started successfully with device: ${videoSource}, detection: ${detectionParam}`);
                } catch (error) {
                    console.error('Error accessing the camera: ', error);
                }
            }

            function stopStream() {
                console.log("Stopping stream...");
                if (currentStream) {
                    const tracks = currentStream.getTracks();
                    tracks.forEach(track => track.stop());
                    videoElement.srcObject = null;
                    currentStream = null;
                    videoSelect.disabled = false;  // Enable the dropdown
                    videoElement.style.backgroundColor = 'black';  // Turn the video element black
                    videoElement.src = "";  // Clear the src attribute
                    console.log("Stream stopped and video element turned black.");
                }
            }

            function toggleDetection() {
                isDetectionEnabled = !isDetectionEnabled;
                toggleDetectionButton.textContent = isDetectionEnabled ? 'Disable Detection' : 'Enable Detection';
                toggleDetectionButton.className = isDetectionEnabled ? 'button-green' : 'button-red';
                console.log("Object detection enabled:", isDetectionEnabled);
            }

            // Event listeners for start, stop, and toggle detection buttons
            startButton.addEventListener('click', startStream);
            stopButton.addEventListener('click', stopStream);
            toggleDetectionButton.addEventListener('click', toggleDetection);
        </script>
    </div>
</body>

</html>